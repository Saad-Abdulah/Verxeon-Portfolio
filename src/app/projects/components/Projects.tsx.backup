'use client'

import { motion } from 'framer-motion'
import { ExternalLink, Github, ArrowRight, Eye, Code, Globe, Brain, Shield, Cloud, Filter, Search, Calendar, DollarSign, Clock, Users, Loader2, Database, Smartphone, Zap, Target } from 'lucide-react'
import Link from 'next/link'
import { useMemo, useState } from 'react'
import { getFileView } from '@/lib/appwrite'
import Image from 'next/image'
import { useAppData } from '@/app/Providers'

interface Project {
  $id: string
  title: string
  longDescription: string
  services: string[] // Changed from category to services
  technologies: string[]
  features: string[]
  mainPicture: string
  liveUrl?: string
  createdAt: string
  updatedAt: string
  client: string
  duration: string
  results: string[]
}

const Projects = () => {
  const { projects: allProjects, industries, isLoading, error } = useAppData()

  const [selectedIndustry, setSelectedIndustry] = useState('All')
  const [searchTerm, setSearchTerm] = useState('')

  // Helper function to get industry name by ID
  const getIndustryNameById = (industryId: string) => {
    const industry = (industries || []).find((ind: any) => ind.$id === industryId)
    return industry ? industry.name : industryId
  }

  // Helper: extract industry IDs from services
  const getIndustryIdsFromServices = (services: any[]) => {
    if (!services || !Array.isArray(services)) return []
    return services
      .map((service) => (typeof service === 'string' ? service : service?.$id || null))
      .filter(Boolean) as string[]
  }

  // Options for filter
  const industryOptions = useMemo(() => {
    const ids = new Set<string>()
    ;(allProjects || []).forEach((p: any) => {
      getIndustryIdsFromServices(p.services || []).forEach((id) => ids.add(id))
    })
    return ['All', ...Array.from(ids)]
  }, [allProjects])

  const filteredProjects = useMemo(() => {
    const list = (allProjects || []) as any[]
    return list.filter((project) => {
      const projectIndustryIds = getIndustryIdsFromServices(project.services || [])
      const matchesIndustry = selectedIndustry === 'All' || projectIndustryIds.includes(selectedIndustry)
      const text = `${project.title} ${project.longDescription}`.toLowerCase()
      const matchesSearch = text.includes(searchTerm.toLowerCase())
      return matchesIndustry && matchesSearch
    })
  }, [allProjects, selectedIndustry, searchTerm])

  return (
    <section id="projects" className="py-20 relative overflow-hidden bg-page-background">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Section Header */}
        <motion.div
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          viewport={{ once: true }}
          className="text-center mb-16"
        >
          <h2 className="text-4xl font-bold mb-6 text-card-primary">
            Our Portfolio
          </h2>
          <p className="text-xl text-card-secondary max-w-3xl mx-auto leading-relaxed">
            Discover how we've helped businesses transform their operations through innovative technology solutions. 
            Each project represents our commitment to excellence and client success.
          </p>
        </motion.div>

        {/* Filter Section */}
        <section className="pb-12 relative bg-page-background">
          <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            {/* Filter Buttons */}
            <div className="flex flex-wrap justify-center gap-3 mb-8">
              {industryOptions.map((industryId) => (
                <button
                  key={industryId}
                  onClick={() => setSelectedIndustry(industryId)}
                  className={`px-4 py-1 rounded-full text-lg font-medium transition-all duration-300 ${
                    selectedIndustry === industryId 
                      ? 'bg-primary text-white shadow-primary' 
                      : 'bg-card border border-primary/20 text-card-secondary hover:border-primary/40 hover:text-primary'
                  }`}
                >
                  {industryId === 'All' ? industryId : getIndustryNameById(industryId)}
                </button>
              ))}
            </div>

            {/* Search Bar */}
            <div className="max-w-md mx-auto mb-8">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-card-secondary" />
                <input
                  type="text"
                  placeholder="Search projects..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 md:py-3 bg-card border border-primary/20 rounded-full text-card-primary placeholder-card-secondary focus:outline-none focus:border-primary transition-colors duration-200 w-full"
                />
              </div>
            </div>
          </div>
        </section>

        {/* Projects Grid */}
        <section className="pb-20 relative bg-page-background">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            {isLoading && filteredProjects.length === 0 ? (
              <div className="text-center py-20">
                <Loader2 className="h-16 w-16 text-primary animate-spin mx-auto" />
                <p className="text-card-secondary mt-4">Loading projects...</p>
              </div>
            ) : error ? (
              <div className="text-center py-20">
                <div className="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 className="text-2xl font-bold text-card-primary mb-2">Error: {error}</h3>
                <p className="text-card-secondary mb-6">Failed to load projects. Please try again.</p>
              </div>
            ) : filteredProjects.length === 0 ? (
              <div className="text-center py-20">
                <div className="text-6xl mb-4">üîç</div>
                <h3 className="text-2xl font-bold text-card-primary mb-2">No Projects Found</h3>
                <p className="text-card-secondary mb-6">Try adjusting your search or filter criteria.</p>
                <button 
                  onClick={() => { setSearchTerm(''); setSelectedIndustry('All'); }}
                  className="btn-primary"
                >
                  Clear Filters
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {filteredProjects.map((project: any, index: number) => (
                  <motion.div
                    key={project.$id}
                    initial={{ opacity: 0, y: 20 }}
                    whileInView={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.5, delay: index * 0.1 }}
                    viewport={{ once: true }}
                    className="group relative"
                  >
                    {/* Project Card */}
                    <div className="bg-card shadow-card rounded-xl overflow-hidden hover:scale-[1.01] transition-all duration-300 h-full flex flex-col">
                      {/* Project Image */}
                      <div className="relative h-48 overflow-hidden">
                        {project.mainPicture ? (
                          <Image
                            src={getFileView(project.mainPicture)}
                            alt={project.title}
                            fill
                            className="object-cover group-hover:scale-105 transition-transform duration-500"
                            sizes="(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
                          />
                        ) : (
                          <div className="w-full h-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                            <Code className="h-16 w-16 text-white" />
                          </div>
                        )}
                        
                        {/* Service Buttons Overlay - Lower Right Corner */}
                        {project.services && project.services.length > 0 && (
                          <div className="absolute bottom-3 right-3 flex flex-col gap-2 max-w-[calc(100%-24px)]">
                            {project.services.map((service: any, serviceIndex: number) => {
                              const serviceId = typeof service === 'string' ? service : service.$id;
                              const serviceName = typeof service === 'string' ? service : service.name || serviceId;
                              return (
                                <Link
                                  key={serviceIndex}
                                  href={`/industries/${serviceId}`}
                                  className="inline-flex items-center gap-1 px-2 py-1 bg-white/90 backdrop-blur-sm text-secondary text-xs font-medium rounded-full shadow-lg hover:bg-white hover:shadow-xl hover:text-primary transition-all duration-300 cursor-pointer group"
                                >
                                  <ExternalLink className="h-3 w-3 opacity-60 group-hover:opacity-100 transition-opacity" />
                                  <span className="truncate max-w-24">{serviceName}</span>
                                </Link>
                              );
                            })}
                          </div>
                        )}
                      </div>

                      {/* Project Content */}
                      <div className="p-6 flex-1 flex flex-col">
                        <div className="flex items-center justify-between">
                        <h3 className="text-xl font-bold text-card-primary group-hover:text-primary transition-colors duration-300 mb-2">
                          {project.title}
                        </h3>
                        
                        
                        </div>
                        <p className="text-card-secondary text-sm leading-relaxed mb-4 flex-1">
                          {project.longDescription && project.longDescription.length > 100 
                            ? `${project.longDescription.substring(0, 100)}...`
                            : project.longDescription
                          }
                        </p>

                        {/* Technologies */}
                        <div className="mb-4 flex-1">
                          <div className="flex flex-wrap gap-2">
                            {project.technologies && project.technologies.length > 0 ? (
                              <>
                                {project.technologies.slice(0, 3).map((tech: string, techIndex: number) => (
                                  <span
                                    key={techIndex}
                                    className="px-3 py-1 bg-card text-card-secondary text-xs rounded-full border border-primary/20"
                                  >
                                    {tech}
                                  </span>
                                ))}
                                {project.technologies.length > 3 && (
                                  <span className="px-3 py-1 bg-primary/10 text-primary text-xs rounded-full border border-primary/20">
                                    +{project.technologies.length - 3} more
                                  </span>
                                )}
                              </>
                            ) : (
                              <span className="px-3 py-1 bg-card text-card-secondary text-xs rounded-full border border-primary/20">
                                No technologies listed
                              </span>
                            )}
                          </div>
                        </div>

                        {/* Project Actions */}
                        <div className="flex gap-3 mt-auto">
                          {project.liveUrl && (
                            <a
                              href={project.liveUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="inline-flex items-center justify-center px-4 py-2 bg-card border border-primary/20 text-primary rounded-lg text-sm font-medium hover:bg-primary/5 hover:border-dark hover:shadow-lg hover:shadow-primary/20 transition-all duration-300"
                            >
                              <Eye className="h-3 w-3 mr-1 -ml-2" />
                              <span>View Live</span>
                            </a>
                          )}
                          <Link
                            href={`/projects/${project.$id}`}
                            className="inline-flex items-center justify-center px-4 py-2 bg-card border border-primary/20 text-primary rounded-lg text-sm font-medium hover:bg-primary/5 hover:border-dark hover:shadow-lg hover:shadow-primary/20 transition-all duration-300"
                          >
                            View Details
                          </Link>
                        </div>
                      </div>
                    </div>
                  </motion.div>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* CTA Section */}
        <section className="py-20 relative bg-page-background">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <motion.div
              initial={{ opacity: 0, y: 30 }}
              whileInView={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8 }}
              viewport={{ once: true }}
            >
              <h2 className="text-3xl font-bold text-card-primary mb-6">
                Ready to Start Your Project?
              </h2>
              <p className="text-xl text-card-secondary mb-8 max-w-2xl mx-auto">
                Let's discuss how we can help bring your vision to life with innovative technology solutions.
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <Link href="/contact" className="btn-primary px-8 py-4">
                  Start Your Project
                </Link>
                <Link href="/industries" className="btn-secondary px-8 py-4">
                  View Our Services
                </Link>
              </div>
            </motion.div>
          </div>
        </section>
      </div>
    </section>
  )
}

export default Projects 